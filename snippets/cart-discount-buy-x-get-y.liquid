{%- doc -%}
  Renders a "Buy X Get Y" discount display component for cart-level discounts.
  
  This component shows a progress indicator for Buy X Get Y promotions
  based on theme settings configuration. Only eligible products/collections
  count towards the promotion progress. Free items can be targeted separately
  from promotion-eligible items.

  @param {number} current_quantity - Current quantity in cart (default: 0)
{%- enddoc -%}

{% liquid
  assign current_quantity = current_quantity | default: 0

  # Get settings from theme configuration
  assign required_quantity = settings.buy_x_get_y_required_quantity | default: 2
  assign item_label = settings.buy_x_get_y_item_label | default: 'Kits'

  # Get eligible collections and products from settings
  assign eligible_collections = settings.buy_x_get_y_eligible_collections
  assign eligible_products = settings.buy_x_get_y_eligible_products
  
  # Get free items collections and products from settings
  assign free_items_collections = settings.buy_x_get_y_free_items_collections
  assign free_items_products = settings.buy_x_get_y_free_items_products

  # Calculate eligible quantity from cart items
  assign eligible_quantity = 0
  
  # If no collections or products are specified, all items are eligible
  if eligible_collections == blank and eligible_products == blank
    assign eligible_quantity = current_quantity
  else
    # Check each cart item against eligible collections and products
    for item in cart.items
      assign is_eligible = false
      
      # Check if product is in eligible products list
      if eligible_products != blank
        for eligible_product in eligible_products
          if item.product.id == eligible_product.id
            assign is_eligible = true
            break
          endif
        endfor
      endif
      
      # Check if product is in eligible collections
      if is_eligible == false and eligible_collections != blank
        for eligible_collection in eligible_collections
          for collection in item.product.collections
            if collection.id == eligible_collection.id
              assign is_eligible = true
              break
            endif
          endfor
          if is_eligible
            break
          endif
        endfor
      endif
      
      # Add quantity if eligible
      if is_eligible
        assign eligible_quantity = eligible_quantity | plus: item.quantity
      endif
    endfor
  endif

  # Get color settings from theme configuration
  assign progress_bar_bg = settings.buy_x_get_y_progress_bar_background | default: '#E6E6E6'
  assign progress_bar_fill = settings.buy_x_get_y_progress_bar_fill | default: '#000000'
  assign icon_bg = settings.buy_x_get_y_icon_background | default: '#E6E6E6'
  assign icon_active_bg = settings.buy_x_get_y_icon_active_background | default: '#000000'

  # Get free items count from theme configuration
  assign max_free_items_count = settings.buy_x_get_y_free_items_count | default: 1
  
  # Calculate actual free items that can be applied based on eligible items in cart
  assign free_items_remaining = 0
  if eligible_quantity >= required_quantity
    # Calculate how many complete sets of required_quantity we have
    assign complete_sets = eligible_quantity | divided_by: required_quantity
    # Calculate total free items earned
    assign total_free_items_earned = complete_sets | times: max_free_items_count
    # Calculate how many free items are already in cart (eligible items that are free)
    assign free_items_in_cart = 0
    
    # Check each cart item to see if it's a free item
    for item in cart.items
      assign is_free_item_eligible = false
      
      # Check if product is in free items products list
      if free_items_products != blank
        for free_product in free_items_products
          if item.product.id == free_product.id
            assign is_free_item_eligible = true
            break
          endif
        endfor
      endif
      
      # Check if product is in free items collections
      if is_free_item_eligible == false and free_items_collections != blank
        for free_collection in free_items_collections
          for collection in item.product.collections
            if collection.id == free_collection.id
              assign is_free_item_eligible = true
              break
            endif
          endfor
          if is_free_item_eligible
            break
          endif
        endfor
      endif
      
      # If no free items targeting is set, all products can be free items
      if free_items_products == blank and free_items_collections == blank
        assign is_free_item_eligible = true
      endif
      
      # If this is a free-item-eligible product and it's marked as free (has discount)
      if is_free_item_eligible and item.final_line_price < item.original_line_price
        assign free_items_in_cart = free_items_in_cart | plus: item.quantity
      endif
    endfor
    
    # Calculate remaining free items
    assign free_items_remaining = total_free_items_earned | minus: free_items_in_cart
    assign free_items_remaining = free_items_remaining | at_least: 0
  endif

  # Generate dynamic promotion title based on settings
  if settings.buy_x_get_y_promotion_title != blank
    assign promotion_title = settings.buy_x_get_y_promotion_title
  else
    assign promotion_title = 'Buy ' | append: required_quantity | append: ' Get ' | append: max_free_items_count | append: ' Free 🎁'
  endif

  # Replace variables in promotion title
  assign promotion_title = promotion_title | replace: '{{ count }}', required_quantity | replace: '{{ free_items }}', max_free_items_count

  # Get message settings from theme configuration
  if settings.buy_x_get_y_offer_unlocked_message != blank
    assign offer_unlocked_message = settings.buy_x_get_y_offer_unlocked_message
  else
    assign offer_unlocked_message = 'content.buy_x_get_y_default_offer_unlocked' | t
  endif

  if settings.buy_x_get_y_add_more_message != blank
    assign add_more_message = settings.buy_x_get_y_add_more_message
  else
    assign add_more_message = 'content.buy_x_get_y_default_add_more' | t
  endif

  # Calculate progress percentage using eligible quantity
  assign progress_percentage = eligible_quantity | times: 100 | divided_by: required_quantity
  assign progress_percentage = progress_percentage | at_most: 100
%}

<div
  class="cart-discount-buy-x-get-y"
  role="status"
  aria-live="polite"
  style="
    --buy-x-get-y-progress-bg: {{ progress_bar_bg }};
    --buy-x-get-y-progress-fill: {{ progress_bar_fill }};
    --buy-x-get-y-icon-bg: {{ icon_bg }};
    --buy-x-get-y-icon-active-bg: {{ icon_active_bg }};
    --total-icons: {{ required_quantity | plus: 1 }};
  "
>
  <div class="cart-discount-buy-x-get-y__header">
    <span class="cart-discount-buy-x-get-y__title">
      {{ promotion_title | escape }}
    </span>
    <span class="cart-discount-buy-x-get-y__progress-text">
      {%- if eligible_quantity >= required_quantity -%}
        {{ eligible_quantity }} {{ item_label }} + {{ free_items_remaining }} Free
      {%- else -%}
        {{ eligible_quantity }}/{{ required_quantity }} {{ item_label }}
      {%- endif -%}
    </span>
  </div>

  <div class="cart-discount-buy-x-get-y__progress-container">
    <div
      class="cart-discount-buy-x-get-y__progress-bar"
      role="progressbar"
      aria-valuemin="0"
      aria-valuemax="{{ required_quantity }}"
      aria-valuenow="{{ eligible_quantity }}"
      style="background-color: {{ progress_bar_bg }};"
    >
      <div
        class="cart-discount-buy-x-get-y__progress-fill"
        style="transform: translateX(-{{ 100 | minus: progress_percentage }}%); background-color: {{ progress_bar_fill }};"
      ></div>
    </div>

    <div class="cart-discount-buy-x-get-y__progress-icons">
      <div class="cart-discount-buy-x-get-y__progress-icon cart-discount-buy-x-get-y__progress-icon--active">
        <svg
          xmlns="http://www.w3.org/2000/svg"
          width="24"
          height="24"
          viewBox="0 0 24 24"
          fill="none"
          stroke="currentColor"
          stroke-width="2"
          stroke-linecap="round"
          stroke-linejoin="round"
          aria-hidden="true"
        >
          <path d="M16 10a4 4 0 0 1-8 0"></path>
          <path d="M3.103 6.034h17.794"></path>
          <path d="M3.4 5.467a2 2 0 0 0-.4 1.2V20a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V6.667a2 2 0 0 0-.4-1.2l-2-2.667A2 2 0 0 0 17 2H7a2 2 0 0 0-1.6.8z"></path>
        </svg>
      </div>

      <!-- Dynamic center icons based on required_quantity -->
      {%- for i in (2..required_quantity) -%}
        <div class="cart-discount-buy-x-get-y__progress-icon {% if eligible_quantity >= i %}cart-discount-buy-x-get-y__progress-icon--active{% endif %}">
          <svg
            xmlns="http://www.w3.org/2000/svg"
            width="24"
            height="24"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
            stroke-linecap="round"
            stroke-linejoin="round"
            aria-hidden="true"
          >
            <path d="M16 10a4 4 0 0 1-8 0"></path>
            <path d="M3.103 6.034h17.794"></path>
            <path d="M3.4 5.467a2 2 0 0 0-.4 1.2V20a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V6.667a2 2 0 0 0-.4-1.2l-2-2.667A2 2 0 0 0 17 2H7a2 2 0 0 0-1.6.8z"></path>
          </svg>
        </div>
      {%- endfor -%}

      <!-- Last icon (gift icon) -->
      <div class="cart-discount-buy-x-get-y__progress-icon {% if eligible_quantity >= required_quantity %}cart-discount-buy-x-get-y__progress-icon--active{% endif %}">
        <svg
          xmlns="http://www.w3.org/2000/svg"
          width="24"
          height="24"
          viewBox="0 0 24 24"
          fill="none"
          stroke="currentColor"
          stroke-width="2"
          stroke-linecap="round"
          stroke-linejoin="round"
          aria-hidden="true"
        >
          <rect x="3" y="8" width="18" height="4" rx="1"></rect>
          <path d="M12 8v13"></path>
          <path d="M19 12v7a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2v-7"></path>
          <path d="M7.5 8a2.5 2.5 0 0 1 0-5A4.8 8 0 0 1 12 8a4.8 8 0 0 1 4.5-5 2.5 2.5 0 0 1 0 5"></path>
        </svg>
      </div>
    </div>
  </div>

  <div class="cart-discount-buy-x-get-y__message">
    {%- if eligible_quantity >= required_quantity -%}
      {%- if free_items_remaining > 0 -%}
        {%- assign message_with_free_items = offer_unlocked_message | replace: '{{ free_items_remaining }}', free_items_remaining -%}
        <span>{{ message_with_free_items | escape }}</span>
      {%- else -%}
        <span>All free items have been applied! 🎉</span>
      {%- endif -%}
    {%- else -%}
      {%- assign remaining = required_quantity | minus: eligible_quantity -%}
      {%- assign message_with_count = add_more_message
        | replace: '{{ count }}', remaining
        | replace: '{{ free_items }}', max_free_items_count
      -%}
      <span>{{ message_with_count | escape }}</span>
    {%- endif -%}
  </div>
</div>

{% stylesheet %}
  .cart-discount-buy-x-get-y {
    border-bottom: 1px solid var(--color-border);
    background: var(--color-background);
  }

  .cart-discount-buy-x-get-y__header {
    display: flex;
    flex-wrap: wrap;
    align-items: center;
    justify-content: space-between;
    padding: var(--padding-md);
  }

  .cart-discount-buy-x-get-y__title {
    display: inline-flex;
    align-items: center;
    gap: var(--gap-xs);
    font-size: var(--font-size--sm);
    font-weight: 600;
    color: var(--color-foreground);
  }

  .cart-discount-buy-x-get-y__progress-text {
    font-size: var(--font-size--xs);
    font-weight: 500;
    color: var(--color-foreground-subdued);
  }

  .cart-discount-buy-x-get-y__progress-container {
    position: relative;
    direction: ltr;
    margin: 0 var(--margin-sm);
  }

  .cart-discount-buy-x-get-y__progress-bar {
    position: relative;
    background-color: var(--buy-x-get-y-progress-bg, var(--color-border));
    overflow: hidden;
    width: 100%;
    height: var(--icon-size-sm);
    border-radius: 9999px;
  }

  .cart-discount-buy-x-get-y__progress-fill {
    height: 100%;
    width: 100%;
    flex: 1;
    background-color: var(--buy-x-get-y-progress-fill, var(--color-primary));
    transition: transform 0.3s ease-in-out;
  }

  .cart-discount-buy-x-get-y__progress-icons {
    position: absolute;
    bottom: 0;
    left: 0;
    right: 0;
    top: 0;
    display: flex;
    align-items: center;
    justify-content: space-between;
  }

  .cart-discount-buy-x-get-y__progress-icon {
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 50%;
    transition: all 0.3s ease-in-out;
    background-color: var(--buy-x-get-y-icon-bg, var(--color-border));
    color: var(--color-foreground-subdued);
    padding: var(--padding-2xs);
    box-shadow: 0 0 0 1px var(--color-border);
  }

  .cart-discount-buy-x-get-y__progress-icon svg {
    height: var(--icon-size-sm);
    width: var(--icon-size-sm);
  }

  .cart-discount-buy-x-get-y__progress-icon--active {
    background-color: var(--buy-x-get-y-icon-active-bg, var(--color-primary));
    color: var(--color-primary-button-text);
    border-color: var(--buy-x-get-y-icon-active-bg, var(--color-primary));
    box-shadow: 0 0 0 1px var(--buy-x-get-y-icon-active-bg, var(--color-primary));
  }

  .cart-discount-buy-x-get-y__progress-icon--transition {
    background: linear-gradient(
      to right,
      var(--buy-x-get-y-icon-active-bg, var(--color-primary)) 50%,
      var(--buy-x-get-y-icon-bg, var(--color-border)) 50%
    );
    color: var(--color-primary-button-text);
    border-color: var(--buy-x-get-y-icon-active-bg, var(--color-primary));
    box-shadow: 0 0 0 1px var(--buy-x-get-y-icon-active-bg, var(--color-primary));
  }

  .cart-discount-buy-x-get-y__message {
    text-align: center;
    padding: var(--padding-xs);
  }

  .cart-discount-buy-x-get-y__message span {
    font-size: var(--font-size--xs);
    font-weight: 500;
    color: var(--color-foreground);
  }

  /* High contrast mode support */
  @media (prefers-contrast: more) {
    .cart-discount-buy-x-get-y {
      border: var(--style-border-width) solid #000000;
      background: #ffffff;
    }

    .cart-discount-buy-x-get-y__title {
      color: #000000;
      font-weight: 700;
    }

    .cart-discount-buy-x-get-y__progress-bar {
      background-color: #000000;
      border: var(--style-border-width) solid #000000;
    }

    .cart-discount-buy-x-get-y__progress-fill {
      background-color: #000000;
    }

    .cart-discount-buy-x-get-y__progress-icon {
      background-color: #ffffff;
      border: var(--style-border-width) solid #000000;
      color: #000000;
    }

    .cart-discount-buy-x-get-y__progress-icon--active {
      background-color: #000000;
      color: #ffffff;
    }

    .cart-discount-buy-x-get-y__progress-icon--transition {
      background: linear-gradient(to right, #000000 50%, #ffffff 50%);
      color: #ffffff;
    }
  }

  /* Responsive adjustments */
  @media (max-width: 480px) {
    .cart-discount-buy-x-get-y__header {
      padding: var(--padding-sm);
    }

    .cart-discount-buy-x-get-y__title {
      font-size: var(--font-size--xs);
    }

    .cart-discount-buy-x-get-y__progress-text {
      font-size: var(--font-size--xs);
    }
  }
{% endstylesheet %}
